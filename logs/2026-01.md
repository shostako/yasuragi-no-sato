## 2026-01-09 作業概要

### 実施内容
- **デザインシステム構築**: カラーパレット（茶系・ベージュ・オフホワイト）、Zen Maru Gothicフォント、コンポーネント定義
- **共通コンポーネント**: Header（スクロール対応、モバイルメニュー）、Footer
- **トップページ実装**: ヒーロー、サービス紹介、施設の特徴、お知らせ、アクセス、CTAセクション
- **要件定義書作成**: `.tmp/requirements.md`, `design.md`, `tasks.md`

### セッション2: Phase 1ページ実装
- **サービスページ**: `/services`（一覧）、`/services/[slug]`（詳細）
  - `app/data/services.ts`でサービスデータを共有化
  - 4サービス対応（デイサービス、ショートステイ、訪問介護、グループホーム）
- **お問い合わせページ**: `/contact`
  - フォームバリデーション実装
  - 送信完了画面実装
  - Supabase連携はPhase 2で実装予定
- **お知らせページ**: `/news`（一覧）、`/news/[id]`（詳細）
  - `app/data/news.ts`でお知らせデータを共有化
  - 簡易Markdownパーサーで本文表示
  - 6記事のサンプルデータ作成

### 技術メモ
- Next.js 16 + Tailwind CSS 4環境
- 画像はプレースホルダー（picsum.photos）使用中
- Playwrightでのスクリーンショット検証にはJPEG形式が有効（PNG形式だと色が薄く見える場合あり）
- Next.js 16では`params`がPromiseになったため、`generateMetadata`も`async`で`await params`が必要

### 次回タスク
- 施設案内ページ群（/about, /about/philosophy, /about/staff, /about/access）
- 採用情報ページ（/recruit）

### セッション3: 施設案内ページ群実装
- **施設案内トップ**: `/about`
  - 施設概要（テーブル形式）、理念プレビュー、施設ギャラリー（6枚）、沿革（タイムライン）
- **理念・方針ページ**: `/about/philosophy`
  - ミッション、価値観（4項目）、施設長メッセージ、ケア方針（3項目）
- **スタッフ紹介ページ**: `/about/staff`
  - スタッフカード（6名）、チーム体制（人数表示）、研修・教育体制
- **アクセスページ**: `/about/access`
  - 地図プレースホルダー、交通案内（電車・バス・車）、駐車場、周辺情報
- **データファイル**: `app/data/about.ts`
  - FacilityInfo, PhilosophyItem, StaffMember, AccessInfo等の型定義
  - 施設基本情報、理念、スタッフ、沿革、ギャラリーデータ

### 次回タスク
- 採用情報ページ（/recruit）

### セッション4: 採用情報ページ実装
- **採用情報ページ**: `/recruit`
  - ヒーローセクション（採用メッセージ）
  - 募集職種（4職種: 介護スタッフ、看護師、ケアマネ、PT/OT）
  - 福利厚生・働く環境（6項目）
  - 先輩スタッフの声（3名）
  - 選考フロー（4ステップ）
  - よくある質問（5項目）
  - CTAセクション
- **データファイル**: `app/data/recruit.ts`
  - JobPosition, Benefit, StaffVoice, SelectionStep, RecruitFAQ型定義
  - 募集職種、福利厚生、スタッフの声、選考フロー、FAQデータ

### Phase 1完了
- 基本ページ実装完了（トップ、サービス、施設案内、お知らせ、お問い合わせ、採用）
- 残タスク: FAQ、プライバシーポリシー、利用規約（低優先度）
- 次フェーズ: Supabase連携、予約システム、会員ポータル

### セッション4続き: FAQページ実装
- **FAQページ**: `/faq`
  - 4カテゴリ（サービス、施設、費用、見学・相談）
  - 15件のFAQ項目
  - アコーディオン形式（クリックで開閉）
  - カテゴリフィルター機能
- **データファイル**: `app/data/faq.ts`

## 2026-01-09 Firebase連携（セッション5）

### 作業内容
- Firebaseプロジェクト作成（yasuragi-no-sato）
- Firebase SDK導入（firebase パッケージ）
- Firestore DB作成（東京リージョン、テストモード）
- お問い合わせフォームをFirebase連携（contactsコレクション）
- お知らせ機能をFirebase連携（newsコレクション）
- シードツール作成（/admin/seed）

### 技術的ポイント
- クライアントサイドのみでFirebase初期化（`typeof window !== "undefined"`）
- お知らせページをクライアントコンポーネントに変更してFirestore取得
- firebase-adminは認証設定が複雑なため、クライアントSDKでシード実行

### 作成・変更ファイル
- `app/lib/firebase.ts` - Firebase初期化
- `.env.local` - Firebase設定（環境変数）
- `app/contact/page.tsx` - Firestore保存追加
- `app/news/page.tsx` - Firestore取得に変更
- `app/news/[id]/page.tsx` - Firestore取得に変更
- `app/admin/seed/page.tsx` - シードツール
- `.firebaserc`, `firebase.json` - Firebase設定

### Firestoreコレクション
- contacts: お問い合わせデータ
- news: お知らせデータ（6件シード済み）

## 2026-01-09 Phase 2完了（セッション6）

### 作業内容
- **見学予約システム**: `/reservation` ページ実装
  - カレンダーUIで日付選択（3日後から予約可能、日曜休み）
  - 時間枠選択（午前10:00〜/午後14:00〜）
  - 予約済み枠の表示機能
  - Firestore `reservations` コレクションに保存
  
- **会員ログイン機能**: Firebase Auth連携
  - ログインページ（/login）
  - 新規登録ページ（/register）
  - 会員ページ（/member）- 認証済みユーザー専用
  - パスワードリセット機能
  - AuthContext で認証状態管理
  - Header にログイン状態表示

- **Vercelデプロイ**
  - GitHubリポジトリ作成: shostako/yasuragi-no-sato
  - Vercel連携・自動デプロイ設定
  - 環境変数設定済み

### 作成ファイル
- `app/reservation/page.tsx` - 見学予約ページ
- `app/login/page.tsx` - ログインページ
- `app/register/page.tsx` - 新規登録ページ
- `app/member/page.tsx` - 会員専用ページ
- `app/contexts/AuthContext.tsx` - 認証コンテキスト
- `app/providers.tsx` - プロバイダーラッパー

### 残タスク
- Firebase Authentication 有効化（Console から手動）
- プライバシーポリシー、利用規約ページ（低優先度）

## 2026-01-09 セッション7: UI改善・ドキュメント作成

### 作業内容
- **ヘッダーナビゲーション修正**
  - 全画面表示で各項目が2行に折り返される問題を修正
  - ブレークポイントをlg(1024px)→xl(1280px)に変更
  - whitespace-nowrapで折り返し防止
  - パディング・ギャップを縮小

- **モバイルメニュー改善**
  - 全幅表示から右寄せ・狭幅(w-64)に変更
  - 縦幅も縮小してコンパクトに

- **依頼者向け説明資料作成**
  - `docs/独自ドメインについて.txt` - ドメイン取得の案内
  - `docs/ホームページ制作の仕組み.txt` - ソースコード・ホスティング・ドメインの説明

### 技術メモ
- Vercel Hobbyプランは商用利用がグレー（Pro推奨$20/月）
- Cloudflare Pagesは無料・商用OK・スリープなし
- Renderの無料Web Serviceは15分でスリープ、復帰に30秒〜1分
- Render Static Sitesはスリープなし

### コミット
- `a969557` fix: ヘッダーナビゲーションの折り返し問題を修正
- `4191ce6` docs: 依頼者向け説明資料を追加

## 2026-01-09 セッション8: 画像差し替え・Figma知見

### 作業内容
- **画像差し替え**
  - `.tmp/介護画像/`から11枚の画像を`public/images/`にコピー
  - 日本語ファイル名を英語名にリネーム（URL安全性のため）
  - ヒーローセクションに建物外観画像を使用
  - スモークオーバーレイ追加（`from-white/80 via-white/60 to-transparent`）
  - 各ページ・データファイルのpicsum.photos参照をすべて置き換え

- **画像生成リクエスト作成**
  - `.tmp/画像生成リクエスト.txt`に画像生成AI用のプロンプト作成
  - 必須6枚 + 追加5枚の仕様記述

### Figma活用に関する知見
- **Figma MCPは読み取り専用が中心**: デザイン作成はできない、読み取り→コード化が主目的
- **Figma Communityの活用法**:
  1. テンプレートを検索（corporate, healthcare等）
  2. 気に入ったものをDuplicate
  3. URLをClaudeに渡す
  4. Figma MCPでデザイン読み取り→コード化
- **Figma無料プラン**: 3ファイルまで、1ファイル=1プロジェクト単位（かなり余裕）
- **次回プロジェクトへの提案**: 最初にFigma Communityでテンプレート探しから始める

### 画像マッピング
| 日本語名 | 英語名 | 用途 |
|---------|--------|------|
| 建物外観.png | hero-building.png | ヒーロー背景 |
| 介護風景.jpg | care-scene.jpg | 24時間ケア |
| 歩行練習.jpg | walking-practice.jpg | リハビリ設備 |
| 共有スペース.jpg | common-space.jpg | 食事、デイルーム |
| 個室案内.jpg | private-room.jpg | 居室、ショートステイ |
| 散歩.jpg | walk.jpg | 中庭、グループホーム |
| スタッフ紹介.jpg | staff.jpg | スタッフ全般 |
| 車いす説明.jpg | wheelchair.jpg | 訪問介護 |
| 見学.jpg | tour.jpg | 見学関連 |
| 施設説明.jpg | facility-info.jpg | 施設説明全般 |
| ぬいぐるみ.jpg | stuffed-animals.jpg | イベント |

### 注意点
- 現在の画像にはiStockウォーターマークが残っている
- 本番用には正規ライセンス画像または画像生成AIで作成した画像が必要

### コミット
- `84defe0` feat: プレースホルダー画像を実画像に置き換え

### セッション運用フィードバック
**/new-projectからの立ち上げ → PROGRESS.mdで引き継ぎ** のフローは正解。

**良かった点**:
- PROGRESS.mdに環境情報・完了済み・未完了・引き継ぎ事項が明確
- 「進捗確認」の一言で即座に状況把握可能
- ログが時系列で追える構成

**改善の余地**:
- 画像等の素材は早めに準備しておくとスムーズ（プロジェクト進行の問題）

**結論**: 他のプロジェクトでも同じやり方でOK。

## 2026-01-11 作業概要

### Nano Banana Pro（AI画像生成）でお知らせ用画像を生成

**実施内容**:
- Antigravity IDE接続を試みるも、ノートブック実行に失敗
- 最終的にBashから直接Pythonスクリプトを実行
- 9枚の画像を生成（施設3枚 + お知らせ6枚）

**生成した画像**:
| 用途 | ファイル |
|------|---------|
| 施設: エントランス | entrance.jpg |
| 施設: 浴室 | bathroom.jpg |
| 施設: 食事風景 | dining.jpg |
| お知らせ: 年末年始 | new-year.jpg |
| お知らせ: 書き初め | kakizome.jpg |
| お知らせ: スタッフ募集 | staff-training.jpg |
| お知らせ: クリスマス | christmas.jpg |
| お知らせ: 感染対策 | infection-prevention.jpg |
| お知らせ: メディア掲載 | media-coverage.jpg |

**技術的知見**:
- Nano Banana Pro = `gemini-3-pro-image-preview`
- 画像生成スクリプト: `scripts/generate-image.py`
- Antigravity IDEはノートブック環境が必要、今回は直接API呼び出しで代用
- 連続生成は6〜7枚で制限がかかる（5時間後にリセット）

**Firestoreデータ更新**:
- `/admin/seed`ページから再シード実行
- 全6件のお知らせに画像パスを追加

## 2026-01-11 作業概要（セッション2）

### Nano Banana Pro Skill拡張
- **編集モード追加**: `--image`オプションで既存画像を元に編集
- **マーキングツール作成**: `mark-image.py`（Annotate風）
  - ドラッグで自由サイズの赤い丸を描画
  - Win+左矢印でウィンドウを左半分にスナップ（ctypes経由）
  - 編集時は赤い丸を自動削除する指示を追加

### Google AI Studio 料金調査
- Tier 1（有料）: 1枚$0.134〜$0.24（約20〜36円）
- Free Tier: 毎日リセットだが制限厳しい（429エラー頻発）
- 結論: Tier 1で安定運用が現実的

### 動画比較（Google AI Studio Build vs Claude Code Skill）
- AI Studio Build: ノーコードでWebアプリ作成、Annotateで視覚的修正
- Claude Code Skill: CLIベース、開発ワークフローに統合
- 用途が異なる。画像生成専用ならAI Studio、開発中に使うならSkill

### その他
- Claude Codeの送信キー（Enter→Ctrl+Enter）変更は不可（機能なし）

## 2026-01-11 作業概要（セッション3）

### 実施内容
- **アクセスページGoogle Maps埋め込み**
  - 都庁の住所（東京都新宿区西新宿2-8-1）で仮設定
  - 外部リンク（Google Maps/Apple Maps）も更新

- **法定ページ追加**
  - プライバシーポリシー（/privacy）- 8条構成
  - 利用規約（/terms）- 8条構成
  - サイトマップ（/sitemap）- 全ページリンク一覧

- **モバイル表示修正**
  - トップページのアクセスセクションが横にはみ出る問題を修正
  - 原因: Google Mapsプレースホルダーの`aspect-[4/3]`と`min-h-[300px]`の組み合わせ
  - 解決: `w-full`追加、セクションに`overflow-hidden`追加

- **モバイルメニューUX改善**
  - メニュー外タップで閉じる機能を追加
  - 透明オーバーレイで実装

### 技術的知見
- Playwrightで横はみ出し要素を特定する方法:
```javascript
document.querySelectorAll('*').forEach(el => {
  const rect = el.getBoundingClientRect();
  if (rect.right > document.documentElement.offsetWidth) {
    console.log(el.className, rect.right - document.documentElement.offsetWidth);
  }
});
```

### コミット
- `fd14ea6` feat: アクセスページにGoogle Maps埋め込み
- `bee4050` feat: プライバシーポリシー・利用規約・サイトマップページ追加
- `8e71f50` fix: モバイル表示の横はみ出し問題を修正
- `c759b58` fix: トップページのアクセスセクションの横はみ出しを修正
- `6de4606` feat: モバイルメニュー外タップで閉じる機能を追加

## 2026-01-11 作業概要（セッション4）

### 管理者モード機能を追加

**実施内容**:
- AuthContextにisAdmin, adminMode, setAdminModeを追加
- ヘッダーに「編集モード」トグルボタンを追加（管理者のみ表示）
- お知らせ一覧ページに「新規投稿」ボタンを追加（編集モード時のみ）
- お知らせ詳細ページに「編集」ボタンを追加（編集モード時のみ）
- lucide-reactパッケージを追加（管理画面で使用していたが未インストールだった）

**管理者モードの使い方**:
1. 管理者アカウントでログイン
2. ヘッダーの「編集」ボタンをクリック → 「編集中」に変わる
3. お知らせページで「新規投稿」「編集」ボタンが表示される
4. WordPressのようなインライン編集UIを実現

**変更ファイル**:
- `app/contexts/AuthContext.tsx` - 管理者モードフラグ追加
- `app/components/Header.tsx` - 編集モードトグル追加
- `app/news/page.tsx` - 新規投稿ボタン追加
- `app/news/[id]/page.tsx` - 編集ボタン追加

### コミット
- `91d4dbe` feat: 管理者モード機能を追加

## 2026-01-13 作業概要

### セキュリティ改善（Codexレビュー対応）
labプロジェクトから`inbox/hpbuild-review-2026-01-13.md`でセキュリティレビュー結果を受領。以下の問題を対応。

#### P0: Firestore Security Rules
- `firestore.rules`新規作成
- 4コレクション（contacts, reservations, news, users）に権限設定
- news: 公開分は誰でも読み取り可、作成/編集/削除は管理者のみ
- users: 本人のみ読み取り可、role変更禁止（自己昇格防止）
- `firebase deploy --only firestore:rules`でデプロイ完了

#### P1: ESLintエラー5件修正
- philosophy/page.tsx: 引用符エスケープ
- recruit/page.tsx: 引用符エスケープ
- admin/setup/page.tsx: any型→FirebaseUser型
- AdminAuthGuard.tsx: useEffect内setState問題解消
- AuthContext.tsx: 同上

#### P2: ドキュメント・設定修正
- CLAUDE.md: Supabase→Firebase、shadcn/ui削除
- next.config.ts: Firebase Storageドメイン追加

#### P3: ESLint警告修正
- 7箇所のimg→next/image変換
- scripts/seed-news.ts: 未使用cert削除

### 再レビュー結果
Codexで再レビュー実施。セキュリティスコア3/5に改善。残課題：
- 高: contacts/reservationsの無認証書き込み（フィールド検証なし）
- 中: newsクエリ不整合（where published == true なし）
- 中: XSSリスク（dangerouslySetInnerHTMLサニタイズなし）
- 低: admin/setup矛盾（role更新禁止ルールとの競合）

## 2026-01-13 本番動作確認・newsクエリ修正

### 実施内容
- **本番サイト全ページ動作確認**: Playwright MCPで24ページをチェック
- **問題発見**: `/news`と`/news/[id]`でFirestoreからデータ取得失敗
- **原因特定**: Security Rulesで`published == true`の条件を設けたが、クエリに`where`句がなかった
- **修正**: `app/news/page.tsx`と`app/news/[id]/page.tsx`に`where("published", "==", true)`追加

### 動作確認結果
| カテゴリ | ページ数 | 結果 |
|----------|----------|------|
| サービス系 | 5 | OK |
| 施設案内系 | 4 | OK |
| お知らせ系 | 2 | 修正後OK |
| その他 | 4 | OK |
| フッター系 | 3 | OK |
| 会員系 | 3 | OK |

### 技術メモ
- Firestoreはクエリ時に全結果がSecurity Rulesを満たせるか保証できないとクエリ全体を拒否する
- `where`句なしの`orderBy`だけでは`published == true || isAdmin()`のルールと整合しない
- 解決策: クエリに`where("published", "==", true)`を追加

## 2026-01-15 管理者アカウント再設定・インデックス作成

### 実施内容
- Firebase Authentication: ダミーアカウント削除、本番用アカウント作成
  - メール: shostakovich1117@gmail.com
  - パスワード: changeme（仮設定）
- Firestore users コレクション: 新ユーザードキュメント作成（role: admin）
- ログイン・編集モード動作確認: OK
- Firestoreコンポジットインデックス作成
  - news コレクション: published (昇順) + date (降順)
  - 理由: `where("published", "==", true)` + `orderBy("date", "desc")` の組み合わせに必要

### 技術メモ
- Firestoreは複数条件のクエリに対してコンポジットインデックスが必要
- インデックスがないとクエリ実行時にエラー発生
- Firebase Consoleから手動作成、またはエラーメッセージのリンクから自動作成可能
- ビルドには数分かかる

### 引き渡し時の注意
- パスワード「changeme」は仮設定。本番運用前に変更必須

## 2026-01-16 管理画面・会員機能実装

### 実装内容

**管理者向け機能**
- `/admin/reservations` - 予約管理画面
  - 予約一覧表示（日付順、ステータスフィルター）
  - ステータス変更（pending → confirmed / cancelled）
  - 予約詳細の展開表示
  - 削除機能
- `/admin/contacts` - お問い合わせ管理画面
  - お問い合わせ一覧表示
  - ステータス変更（new → in_progress → done）
  - 詳細の展開表示
  - 削除機能

**会員機能**
- `/member/profile` - 会員情報編集
  - 表示名の編集（Firebase Auth + Firestore両方更新）
  - パスワードリセットメール送信
- `/member/reservations` - 予約履歴
  - ログインユーザーの予約をuid一致で取得
- `/member/inquiries` - お問い合わせ履歴
  - ログインユーザーのお問い合わせをuid一致で取得

**インフラ変更**
- 予約・お問い合わせフォームにuidフィールド追加（ログイン時自動紐付け）
- Security Rules更新: 自分のデータ（uid一致）は読み取り可能に
- ホームページにGoogle Maps埋め込み（プレースホルダーから置換）

### 技術メモ
- 管理画面は既存の`/admin/news`のUIパターンを踏襲
- `AdminAuthGuard`コンポーネントで管理者権限チェック
- lucide-reactアイコンを活用
- Security Rulesで`resource.data.uid == request.auth.uid`によるアクセス制御

### 残課題
- 通知機能（メール or Firebase Cloud Messaging）
- 予約済み枠の表示修正（ダブルブッキング対策）
- /member/notifications（会員向けお知らせ）

## 2026-01-16 作業ログ（続き）

### ダブルブッキング対策
- **問題**: Security Rulesで一般ユーザーはreservationsをread不可 → 予約済み枠が見えずダブルブッキングの恐れ
- **解決**: bookedSlotsコレクションを新設
  - 公開読み取り可能（日付・時間枠のみ、個人情報なし）
  - 予約作成時にバッチ書き込み（原子性保証）
  - 管理画面でキャンセル時にbookedSlots削除、復帰時に追加

### 会員限定お知らせ機能
- News型に`memberOnly: boolean`フラグ追加
- 管理画面（新規・編集）に「会員限定記事」チェックボックス追加
- /member/notificationsページ作成（会員限定記事一覧）
- Security Rules更新:
  ```
  allow read: if isAdmin() ||
    (resource.data.published == true && (resource.data.memberOnly != true || isAuthenticated()));
  ```

### 変更ファイル
- `app/types/news.ts` - memberOnlyフラグ追加
- `app/admin/news/new/page.tsx` - チェックボックス追加
- `app/admin/news/[id]/edit/page.tsx` - チェックボックス追加
- `app/reservation/page.tsx` - bookedSlotsから取得、バッチ書き込み
- `app/admin/reservations/page.tsx` - キャンセル時bookedSlots削除
- `app/member/notifications/page.tsx` - 新規作成
- `firestore.rules` - bookedSlots, memberOnly対応

### 残タスク
- 通知機能（メール or Firebase Cloud Messaging）← 外部サービス連携が必要、本番運用時に検討

## 2026-01-16 メール通知機能実装

### 実装内容
- Resend導入（月3,000通まで無料）
- `/api/notify` エンドポイント作成
- 予約・問い合わせフォーム送信時にメール通知
- HTMLメールテンプレート（日本語対応）

### 検討した代替案
| サービス | 状況 |
|----------|------|
| LINE Notify | 2025年3月31日でサービス終了済み |
| Gmail SMTP | 将来的に廃止の可能性、非推奨 |
| Resend | 採用。月3,000通無料、安定 |

### 技術的なポイント
- curlでの日本語送信は文字化けする（Windows環境のエンコーディング問題）
- ブラウザからのフォーム送信では問題なし
- HTMLメールには `<meta charset="UTF-8">` を含める

### Vercel環境変数
- `RESEND_API_KEY`: Resend APIキー
- `ADMIN_EMAIL`: 通知先メールアドレス

### 注意点
- Vercelプロジェクトが2つある（hpbuild と yasuragi-no-sato）
- 本番URLは yasuragi-no-sato.vercel.app
- 環境変数は正しいプロジェクト（yasuragi-no-sato）に設定すること

## 2026-01-16 メール通知機能実装

### 実装内容
- **Resend導入**: メール配信サービス（月3,000通まで無料）
- **API Route**: `/api/notify` で予約・問い合わせ時にメール送信
- **通知内容**: 名前、フリガナ、メール、電話番号、問い合わせ内容/予約詳細

### 検討経緯
1. **LINE Notify** → 2025年3月31日にサービス終了済み
2. **Gmail SMTP** → 基本認証廃止、アプリパスワードも将来不透明
3. **Resend** → 月3,000通無料、安定したサービス、Next.js公式推奨

### 技術詳細
- `resend` パッケージ使用
- HTMLメールテンプレート（日本語対応、charset=UTF-8）
- 環境変数: `RESEND_API_KEY`, `ADMIN_EMAIL`
- 通知失敗時もフォーム送信は成功扱い（グレースフルデグラデーション）

### Vercel設定
- 2つのプロジェクトが存在していた（`hpbuild`, `yasuragi-no-sato`）
- 本番URLは`yasuragi-no-sato`の方なので、そちらに環境変数を設定
- `vercel link --project yasuragi-no-sato` で正しいプロジェクトにリンク

### 教訓
- curlでのUTF-8送信はWindows環境で文字化けする
- ブラウザからの送信は問題なし
- Vercelに複数プロジェクトがある場合は`vercel link`でどちらにリンクしているか確認

## 2026-01-16 Codexレビュー対応

### 実施内容
- Codex（Security Analyst + Code Reviewer）によるPhase 6-7のレビュー実施
- 指摘された脆弱性・コード品質問題を修正

### 修正内容
1. **ダブルブッキング競合状態** → Firestoreトランザクション化
2. **予約ステータス更新の非アトミック性** → writeBatchでアトミック化
3. **/api/notify** → バリデーション強化、HTMLエスケープ追加
4. **participants型問題** → Number()で明示的変換
5. **member/notificationsローディングハング** → 未認証時の処理追加

### 変更ファイル
- app/reservation/page.tsx
- app/admin/reservations/page.tsx
- app/api/notify/route.ts
- app/member/notifications/page.tsx

### 技術メモ
- Firestoreの`runTransaction`で読み取り→書き込みをアトミックに
- `writeBatch`は複数ドキュメントの書き込みをアトミックに（読み取り不可）
- トランザクション内で`transaction.get()`→存在チェック→`transaction.set()`
